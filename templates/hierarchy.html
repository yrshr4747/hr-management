{% extends 'layout.html' %}

{% block body %}
<div class="container">
    <h1 class="text-center my-4">Edit Hierarchy</h1>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Add New Department & Designation</h5><hr>
                    <form method="POST" action="">
                        <input type="hidden" name="btn" value="form1">
                        {{ form1.hidden_tag() }}
                        <div class="mb-3">{{ form1.department.label(class="form-label") }}{{ form1.department(class="form-control") }}</div>
                        <div class="mb-3">{{ form1.designation.label(class="form-label") }}{{ form1.designation(class="form-control") }}</div>
                        <div class="mb-3">{{ form1.salary.label(class="form-label") }}{{ form1.salary(class="form-control") }}</div>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Add New Designation</h5><hr>
                    <form method="POST" action="">
                        <input type="hidden" name="btn" value="form2">
                        {{ form2.hidden_tag() }}
                        <div class="mb-3">{{ form2.department.label(class="form-label") }}{{ form2.department(class="form-select") }}</div>
                        <div class="mb-3">{{ form2.designation.label(class="form-label") }}{{ form2.designation(class="form-control") }}</div>
                        <div class="mb-3">{{ form2.salary.label(class="form-label") }}{{ form2.salary(class="form-control") }}</div>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Update Salary</h5><hr>
                    <form method="POST" action="">
                        <input type="hidden" name="btn" value="form3">
                        {{ form3.hidden_tag() }}

                        <div class="mb-3">
                            {{ form3.department.label(class="form-label") }}
                            {# --- ENSURE THIS ID IS CORRECT --- #}
                            {{ form3.department(class="form-select", id="update_department") }}
                        </div>
                        <div class="mb-3">
                            {{ form3.designation.label(class="form-label") }}
                            {# --- ENSURE THIS ID IS CORRECT --- #}
                            {{ form3.designation(class="form-select", id="update_designation") }}
                        </div>
                         <div class="mb-3">
                            {{ form3.salary.label(class="form-label") }}
                            {{ form3.salary(class="form-control") }}
                        </div>
                        <button type="submit" class="btn btn-info">Update</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{# --- THIS JAVASCRIPT RELIES ON THE IDs ABOVE --- #}
<script>
$(document).ready(function() {
    console.log("Hierarchy page JS loaded and document ready."); // DEBUGGING

    const deptSelect = $('#update_department');
    const desigSelect = $('#update_designation');

    // Check if the elements were found
    if (deptSelect.length === 0) {
        console.error("Could not find element with ID: update_department");
    }
     if (desigSelect.length === 0) {
        console.error("Could not find element with ID: update_designation");
    }

    deptSelect.on('change', function() {
        const selectedDepartment = $(this).val();
        console.log('Department changed to:', selectedDepartment); // DEBUGGING

        desigSelect.find('option:not(:first)').remove();
        desigSelect.val('');

        if (selectedDepartment) {
            console.log('Fetching designations for:', selectedDepartment); // DEBUGGING
            $.ajax({
                url: '/get_designations/' + selectedDepartment,
                method: 'GET',
                success: function(designations) {
                    console.log('Received designations:', designations); // DEBUGGING
                    if (designations && designations.length > 0) {
                        designations.forEach(function(desig) {
                            desigSelect.append(new Option(desig, desig));
                        });
                    } else {
                        console.log('No designations found for this department.');
                    }
                },
                error: function(xhr) {
                    console.error('Error fetching designations:', xhr.status, xhr.responseText); // DEBUGGING
                    alert('Could not load designations.');
                }
            });
        } else {
             console.log('No department selected.'); // DEBUGGING
        }
    });
});
</script>
{% endblock %}